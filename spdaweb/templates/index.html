{% load static %}
{% include 'base.html' %}

{% block content %}
<style>
    .card {
        background-color: #ccc;
        color: #000000;
        margin: 20px;
        border: 2px solid white;
    }
</style>

<div class="card">
    <!-- First row -->
    <div class="row p-0.5">
        <div class="col">
            <h5>PROJECTS</h5>
        </div>
    </div>
    <!-- Table and Projects -->
    <div class="card-body">
        <div class="row">
            <div class="col-12" id="Projects">
                <table class="table table-dark table-hover table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">
                                <input type="checkbox">
                            </th>
                            <th scope="col">
                                <i class="bi bi-folder"></i> TITLE
                            </th>
                            <th scope="col">CREATE DATE</th>
                            {% comment %} <th scope="col">LAST UPDATE</th> {% endcomment %}
                            <th scope="col">
                                <i class="bi bi-gear"></i>
                            </th>
                            <th scope="col">ACTIONS</th> <!-- Added actions column -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr>
                            <td><input type="checkbox"></td>
                            <td><i class="bi bi-laptop"></i> <a href="{% url 'project_detail' slug=project.slug %}" class="text-success">{{ project.name }}</a></td>
                            <td>{{ project.created_at|date:"M d, Y, h:i:s A" }}</td>
                            {% comment %} <td>{{ project.last_update|date:"M d, Y, h:i:s A" }}</td> {% endcomment %}
                            <td><i class="bi bi-three-dots-vertical"></i></td>
                            <td><a href="{% url 'project_detail' slug=project.slug %}" class="btn btn-primary">View</a></td> <!-- Added View button -->
                        </tr>
                        <tr class="project-details-container" style="display: none">
                            <td colspan="6">
                                <!-- Project details go here -->
                                <div class="card" style="border: 1px solid black;">
                                    <div class="row spacer">
                                        <!-- Big column -->
                                        <div class="col card border-right">
                                            <div class="row">
                                                <label for="description">Description:<br></label>
                                                <div class="col-12">
                                                    <input type="text" class="form-control" id="description_{{ project.id }}" value="{{ project.Description }}">
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Date and Summary Column -->
                                        <div class="col card border-right">
                                            <div class="row">
                                                <!-- Date column -->
                                                <div class="col card border-right">
                                                    <div class="row">
                                                        <label for="summary">Start Date:<br /></label>
                                                        <div class="col-12">
                                                            <input type="date" class="form-control" id="summary_{{ project.id }}" value="{{ project.startdate }}">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col card border-right">
                                                    <div class="row">
                                                        <label for="summary">End Date:<br /></label>
                                                        <div class="col-12">
                                                            <input type="date" class="form-control" id="summary_{{ project.id }}" value="{{ project.enddate }}">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <br />
                                            <div class="row">
                                                <!-- Scope column -->
                                                <div class="col card border-right">
                                                    <div class="row">
                                                        <label for="summary">Scope:<br /></label>
                                                        <div class="col-12">
                                                            <input type="text" class="form-control" id="summary_{{ project.id }}" value="{{ project.scope }}">
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Version column -->
                                                <div class="col card border-bottom">
                                                    <div class="row">
                                                        <label for="summary">Version:<br /></label>
                                                        <div class="col-12">
                                                            <input type="text" class="form-control" id="summary_{{ project.id }}" value="{{ project.version }}">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <br />
                                        </div>
                                        <div class="col card border-right">
                                            <div class="row">
                                                <label for="summary">Summary:<br /></label>
                                                <div class="col-12">
                                                    <input type="text" class="form-control" id="summary_{{ project.id }}" value="{{ project.Summary }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row spacer">
                                        <div class="col card">
                                            <div class="col">
                                                <div class="row">
                                                    <label for="status">Status:<br /></label>
                                                    <div class="col-12">
                                                        <input type="text" class="form-control" id="status_{{ project.id }}" value="{{ project.status }}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col card">
                                            <div class="row">
                                                <label for="type">Type of Project:<br /></label>
                                                <div class="col-12">
                                                    <input type="text" class="form-control" id="type_{{ project.id }}" value="{{ project.Type_of_project }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary save-btn" onclick="saveProject('{{ project.id }}')">Save</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="row spacer">
    <div class="col text-center">
        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#myModal">
            + Add Project
        </button>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Add Project</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="addProjectForm" action="#">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="name">Name:</label>
                                <input type="text" class="form-control" id="name" name="name" required />
                            </div>
                            <div class="form-group">
                                <label for="scope">Scope:</label>
                                <input type="text" class="form-control" id="scope" name="scope" required />
                            </div>
                            <div class="form-group">
                                <label for="description">Description:</label>
                                <input type="text" class="form-control" id="description" name="Description" required />
                            </div>
                            <div class="form-group">
                                <label for="projecttype">Project Type:</label>
                                <input type="text" class="form-control" id="projecttype" name="projecttype" required />
                            </div>
                            <div class="form-group">
                                <label for="startdate">Start Date:</label>
                                <input type="date" class="form-control" id="startdate" name="startdate" required />
                            </div>
                            <div class="form-group">
                                <label for="enddate">End Date:</label>
                                <input type="date" class="form-control" id="enddate" name="enddate" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="type_of_project">Type of Project:</label>
                                <input type="text" class="form-control" id="type_of_project" name="Type_of_project" required />
                            </div>
                            <div class="form-group">
                                <label for="status">Status:</label>
                                <input type="text" class="form-control" id="status" name="status" required />
                            </div>
                            <div class="form-group">
                                <label for="version">Version:</label>
                                <input type="text" class="form-control" id="version" name="version" required />
                            </div>
                            <div class="form-group">
                                <label for="go_live_date">Go Live Date:</label>
                                <input type="date" class="form-control" id="go_live_date" name="go_live_date" required />
                            </div>
                            <div class="form-group">
                                <label for="pdf_file">PDF File:</label>
                                <input type="file" class="form-control-file" id="pdf_file" name="pdf_file" />
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function saveProject(projectId) {
        var description = document.getElementById('description_' + projectId).value;
        var summary = document.getElementById('summary_' + projectId).value;
        var status = document.getElementById('status_' + projectId).value;
        var type = document.getElementById('type_' + projectId).value;
        var scope = document.getElementById('scope_' + projectId).value;

        fetch('/update_project/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Add CSRF token for security
            },
            body: JSON.stringify({
                id: projectId,
                description: description,
                summary: summary,
                status: status,
                type: type,
                scope: scope
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Project updated successfully:', data);
                // Show success message to the user
                var successMessage = document.createElement('div');
                successMessage.textContent = 'Project updated successfully!';
                successMessage.classList.add('alert', 'alert-success');
                document.body.appendChild(successMessage);
                // Optionally, you can update UI to indicate success
            } else {
                console.error('Failed to update project:', data.errors);
                // Show error message to the user
                var errorMessage = document.createElement('div');
                errorMessage.textContent = 'Failed to update project. Please try again later.';
                errorMessage.classList.add('alert', 'alert-danger');
                document.body.appendChild(errorMessage);
                // Optionally, you can display error messages to the user
            }
        })
        .catch(error => {
            console.error('Error updating project:', error);
            // Handle error, display error message, etc.
            var errorMessage = document.createElement('div');
            errorMessage.textContent = 'An error occurred while updating project. Please try again later.';
            errorMessage.classList.add('alert', 'alert-danger');
            document.body.appendChild(errorMessage);
        });
    }

    $(document).ready(function () {
        $('#addProjectForm').submit(function (e) {
            e.preventDefault(); // Prevent default form submission

            // Submit the form via AJAX
            $.ajax({
                type: 'POST',
                url: '{% url "add_project" %}',  // URL to your view that handles form submission
                data: $(this).serialize(),
                success: function (response) {
                    // Handle success, e.g., close the modal and update the projects list
                    $('#myModal').modal('hide');
                    // You might need to update the projects list here, based on the response from your server
                },
                error: function (error) {
                    // Handle error
                    console.log(error);
                }
            });
        });

        // Show the modal when the "+ Add Project" button is clicked
        $('.btn-success').click(function () {
            $('#myModal').modal('show');
        });

        // Toggle project details visibility
        $(".btn-primary").click(function () {
            var detailsContainer = $(this).closest("tr").next(".project-details-container");
            detailsContainer.toggle();
        });
    });
</script>
{% endblock %}